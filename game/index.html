<!DOCTYPE html>
<html>
	<head>
		<title>TetrEscape</title>
		
		<!-- Mobile support -->
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<meta name="mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		
		<!-- Icons -->
		<link rel="shortcut icon" type="image/x-icon" href="images/favicon.ico" />
		<link rel="icon" sizes="128x128" href="images/logo_128.png" />
		<link rel="apple-touch-icon-precomposed" sizes="128x128" href="images/logo_128.png" />
		
		<!-- Style sheets -->
		<link rel="stylesheet" type="text/css" href="styles/material-elements.css" />
		<link rel="stylesheet" type="text/css" href="styles/material-widgets.css" />
		<link rel="stylesheet" type="text/css" href="styles/material-depth.css" />
		<link rel="stylesheet" type="text/css" href="styles/styles.css" />
		
		<!-- External libraries and polyfills -->
		<script type="text/javascript" src="scripts/raf.js"></script>
		<script type="text/javascript" src="scripts/hammer.min.js"></script>
		<script type="text/javascript" src="scripts/material-touch.js"></script>
		
		<!-- Helper classes -->
		<script type="text/javascript" src="scripts/color.js"></script>
		<script type="text/javascript" src="scripts/vector2d.js"></script>
		<script type="text/javascript" src="scripts/tween.js"></script>
		
		<!-- Menu navigation classes -->
		<script type="text/javascript" src="scripts/view.js"></script>
		<script type="text/javascript" src="scripts/menuview.js"></script>
		
		<!-- Game classes -->
		<script type="text/javascript" src="scripts/game.js"></script>
		<script type="text/javascript" src="scripts/inputmanager.js"></script>
		<script type="text/javascript" src="scripts/grid.js"></script>
		<script type="text/javascript" src="scripts/gridoccupant.js"></script>
		<script type="text/javascript" src="scripts/player.js"></script>
		<script type="text/javascript" src="scripts/goal.js"></script>
		<script type="text/javascript" src="scripts/block.js"></script>
		<script type="text/javascript" src="scripts/staticblock.js"></script>
		<script type="text/javascript" src="scripts/tetromino.js"></script>
		<script type="text/javascript" src="scripts/level.js"></script>
		
		<script type="text/javascript">
			var views,
				canvas,
				game;
			
			window.onload = function () {
				// Enable the play button.
				document.getElementById('playButton').onclick = function () {
					this.view.openSubview(views.levelSelect);
				};
				
				// Enable the instructions button.
				document.getElementById('instructionsButton').onclick = function () {
					this.view.openSubview(views.instructions);
				};
				
				// Enable the game reset button.
				document.getElementById('retryButton').onclick = function () {
					game.reload();
				};
				
				// Populate the level select screen.
				var levelScreenElement = document.getElementById('levelScreen'),
					levelScreenMenu = levelScreenElement.getElementsByClassName('menu')[0];
				for (var i = 0; i < LEVELS.length; i++) {
					var levelButton = document.createElement('button');
					levelButton.innerHTML = 'Level ' + (i + 1) + '<br /><br /><big>&#x2606;&#x2606;&#x2606;</big>';
					levelButton.className = "z1";
					levelButton.dataset.level = i;
					levelButton.onclick = function () {
						this.view.openSubview(views.game);
						startGame(this.dataset.level);
					};
					levelScreenMenu.appendChild(levelButton);
				}
				
				// Create views.
				views = {
					title: new MenuView(document.getElementById('titleScreen')),
					instructions: new View(document.getElementById('instructionsScreen')),
					levelSelect: new MenuView(levelScreenElement),
					game: new View(document.getElementById('gameScreen'))
				};
				
				// Get the game view's app bar.
				views.game.appBar = views.game.elem.getElementsByClassName('appBar')[0];
				
				// Open the title screen.
				views.title.open();
				
				// Ensure the canvas always fits the view.
				canvas = document.getElementById('canvas');
				window.onresize = handleResize;
				handleResize();
			};
			
			function handleResize() {
				canvas.width = window.innerWidth;
				canvas.height = window.innerHeight - views.game.appBar.offsetHeight;
				if (game) {
					game.rescale();
				}
			}
			
			function startGame(level) {
				game = null;
				game = new Game(canvas, LEVELS[level], endGame);
			}
			
			function endGame() {
				game = undefined;
				views.game.close();
				views.levelSelect.resume();
			}
		</script>
	</head>
	<body>
		<div class="view" id="titleScreen">
			<br />
			<img src="images/logo.png" alt="TetrEscape" style="max-height: 50%;" />
			<br />
			<div class="menu">
				<button class="z1" id="playButton">Play</button>
				<button class="z1" id="instructionsButton">Instructions</button>
			</div>
		</div>
		
		<div class="view" id="instructionsScreen">
			<header class="appBar toolbar z2">
				<button class="backButton" title="Back (Esc)">
					<img src="images/back.png" alt="Back" />
				</button>
				Instructions
			</header>
			<img src="images/instructions.png" alt="Use the arrow keys or touch swipes to move" style="max-width: 90%; display: block; margin: auto;" />
			<p>Move around using directional keys or touch swipes, slide blocks around, and try to reach the exit!</p>
		</div>
		
		<div class="view" id="levelScreen">
			<header class="appBar toolbar z2">
				<button class="backButton" title="Back (Esc)">
					<img src="images/back.png" alt="Back" />
				</button>
				Select level
			</header>
			<div class="menu"></div>
		</div>
		
		<div class="view" id="gameScreen">
			<header class="appBar toolbar z1">
				<button class="backButton" title="Quit (Esc)">
					<img src="images/close.png" alt="Quit" />
				</button>
				<button id="retryButton" title="Retry (R)" style="float: right; margin-right: -12px;">
					<img src="images/replay.png" alt="Retry" />
				</button>
			</header>
			<canvas id="canvas" width="640" height="480"></canvas>
		</div>
	</body>
</html>
